---
layout: post
title: 完全向前保密 Perfect Forward Secrecy
---

### TSL并不是在任何时候都安全

加密的HTTP通信可以保护传输中的数据不被窃取和修改，这样做看似无懈可击，但其实还是有风险。
传输过程中的信息是经过加密后的密文，在没有秘钥的情况下想要破解出原始信息，要么暴力破解，要么直接针对加密算法进行分析和破解，无论采取哪种方式，其成本都是非常高的，于是就有人转变思路，先把这些加密的HTTP通信录制下来，虽然目前无法对其解密，但是5年后，10年后，甚至经过更长的时间之后，用来对这些HTTP通信数据进行加密的秘钥有可能因为各种方式泄露出来，到那个时候就可以很容易的把这些录制下来的通信解密了。这可不只是停留在理论阶段，事实上[美国国家安全局（NSA）已经在这么做了]。

接下来的内容需要你对TSL有所了解，虽然没必要弄清楚TSL中的每一个细节，但至少得知道建立TSL连接最开始的时候发生了，建议可以先看看这篇[阮一峰对HTTPS的介绍：《SSL/TSL协议运行机制的概述》]文章。如果实在懒得去看的话，也不必担心，我会尽量用简单易懂的文字来介绍这种“延时类”的攻击是如何得手的，以及为什么完全向前保密（PFS）能防止这类攻击。

### SSL/TSL协议基本运行过程
在建立起安全可靠的传输连接之前，客户端和服务器会进行协议握手，交换一些后面会用到的信息，具体细节可以参考上面提到的那篇文章，本文为了尽量简单易懂的对问题进行介绍，所以暂时省略了一些细节。言归正传，SSL/TSL协议基本运行过程如下：

1. 客户端生成 **随机数1**，发送给服务器
2. 服务器生成 **随机数2**，并且把证书一并发送给客户端
3. 客户端生成 **随机数3（也叫做Pre-MasterKey）**，并且使用服务器提供的证书中的 **公钥** 对 随机数3 进行加密，之后把加密后的密文发送给服务器
4. 服务器接收到客户端发送来的经过加密后的随机数3，并且用自己的 **私钥** 对其进行解密，得到 随机数3 的原文
5. 此时客户端和服务器分别拿到了3个随机数，之后两边基于这3个随机数生成 **会话密钥**，在之后的通信中使用这个会话秘钥对数据进行 **对称加密**

### 面临的问题：现在录制，以后破解
在上面提到的握手过程中，随机数1、随机数2等数据都是**明文**传输的，只有随机数3是通过**服务器的公钥**加密后交给服务器的。也就是说，如果第三方在监听客户端和服务器之间的通信，他可以看到随机数1、随机数2，假如第三方通过某种方式知道了随机数3，那他就可以生成正确的会话密钥，从而使用这个密钥来解密客户端和服务器之间的密文通信数据。那么问题来了，第三方如何知道随机数3呢？

就目前来看，办法不外乎是暴力破解会话密钥，或者是找到算法漏洞从而破解出这个密钥，而无论采取哪种方式成本都是相当的高，不过NSA另辟蹊径，采用了另外一种方式：既然**现在**一时半会儿无法破解，那就先把这些通信数据全部录制下来，等到**将来**服务器的私钥因为各种原因泄露了，或者找到其他低成本的破解私钥的办法了，那就可以破解出随机数3，而后就能知道会话密钥，解密通信数据也就不是问题了。

### 使用PFS保护数据
这里问题的关键在于，服务器的私钥即用于了身份验证，同时还用于解密得到随机数3，在服务器私钥没有泄漏的情况下这么做是安全的，可是一旦私钥泄漏了，那么攻击者就能解密得到随机数3，之后计算出Pre-MasterKey，并生成正确的会话密钥来解密录制下来的通信数据，可谓千里之堤毁于蚁穴。可别以为这样的事情不可能发生，想想之前爆发的[OpenSSL心血漏洞]。

解决办法也有：采用Pefect Forward Secrecy技术，在SSL/TSL握手阶段不再加密和传递随机数3，而是采用[Diffie-Hellman算法]（简称DH算法），在客户端和服务器端分别生成随机数1和随机数2的时候，顺带再交换一些用于DH计算的必要参数，之后客户端和服务器就可以直接生成同样的Pre-MasterKey，之后生成会话密钥用于后续的加密。有几个关键点有必要特别说明一下：

1. 虽然客户端和服务器在握手阶段交换的数据都是明文传输的，但是它们各自还生成了一些只有各自才知道的私有数据（其实也是各自生成一对公钥和私钥，并把各自的公钥交给对方）用于DH算法
2. 通过神奇的DH算法，客户端和服务器能在参数 **【不同的】** 情况下（虽然双方生成的随机数、DH算法参数是相同的，但是双方的私钥是不同的）生成 **【同样的】** Pre-MasterKey，之后基于这个Pre-MasterKey生成会话密钥
3. 在每次建立连接的时候，由于服务器生成的用于DH算法的数据都不一样，因此每次的Pre-MasterKey也不一样，也就是说每次的会话密钥都是不同的，这样一来就算服务器生成的私钥泄漏了，也仅能解密出对应的那次会话的Pre-MasterKey及其会话密钥，而由其它会话密钥加密的数据不会受到影响


### 参考资料
- [SSL/TSL & Perfect Forward Secrecy] 
- [Forward secrecy for Google HTTPS]

[美国国家安全局（NSA）已经在这么做了]: http://forbes.com/sites/andygreenberg/2013/06/20/leaked-nsa-doc-says-it-can-collect-and-keep-your-encrypted-data-as-long-as-it-takes-to-crack-it/
[阮一峰对HTTPS的介绍：《SSL/TSL协议运行机制的概述》]:http://www.ruanyifeng.com/blog/2014/02/ssl_TSL.html
[Diffie-Hellman算法]:http://baike.baidu.com/view/551692.htm
[OpenSSL心血漏洞]: https://en.wikipedia.org/wiki/Heartbleed
[SSL/TSL & Perfect Forward Secrecy]: http://vincent.bernat.im/en/blog/2011-ssl-perfect-forward-secrecy.html
[Forward secrecy for Google HTTPS]: https://www.imperialviolet.org/2011/11/22/forwardsecret.html